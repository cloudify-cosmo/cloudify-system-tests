tosca_definitions_version: cloudify_dsl_1_0

imports:
    - http://www.getcloudify.org/spec/cloudify/3.1/types.yaml
    - http://www.getcloudify.org/spec/openstack-plugin/1.1/plugin.yaml


inputs:
    server_name: {}
    image_name: {}
    flavor_name: {}
    private_key_path: {}

node_templates:
    nova_server:
        type: cloudify.openstack.nodes.Server
        relationships:
           -   type: cloudify.relationships.connected_to
               target: neutron_port
           -   type: cloudify.openstack.server_connected_to_security_group
               target: security_group_dst
           -   type: cloudify.openstack.server_connected_to_floating_ip
               target: floatingip
           -   type: cloudify.openstack.server_connected_to_keypair
               target: keypair
        properties:
            install_agent: false
            cloudify_agent:
                user: ubuntu
                port: 22
            server:
                name: { get_input: server_name }
                image_name: { get_input: image_name }
                flavor_name: { get_input: flavor_name }
    neutron_network:
        type: cloudify.openstack.nodes.Network
        properties:
            network:
                name: neutron_network_test
    neutron_subnet:
        type: cloudify.openstack.nodes.Subnet
        relationships:
            -   type: cloudify.relationships.contained_in
                target: neutron_network
            -   type: cloudify.openstack.subnet_connected_to_router
                target: neutron_router
        properties:
            subnet:
                name: neutron_subnet_test
                ip_version: 4
                cidr: 10.10.10.0/24
    neutron_router:
        type: cloudify.openstack.nodes.Router
        properties:
            router:
                name: neutron_router_test
    neutron_port:
        type: cloudify.openstack.nodes.Port
        properties:
            port:
                name: neutron_test_port
        relationships:
            -   type: cloudify.relationships.contained_in
                target: neutron_network
            -   type: cloudify.relationships.depends_on
                target: neutron_subnet
            -   type: cloudify.openstack.port_connected_to_security_group
                target: security_group_src
    security_group_src:
        type: cloudify.openstack.nodes.SecurityGroup
        properties:
            security_group:
                name: neutron_test_security_group_src
    security_group_dst:
        type: cloudify.openstack.nodes.SecurityGroup
        properties:
            security_group:
                name: neutron_test_security_group_dst
            disable_default_egress_rules: True
            rules:
                -   remote_ip_prefix: 1.2.3.0/24
                    port: 80
                -   remote_ip_prefix: 2.3.4.0/24
                    port_range_min: 65500
                    port_range_max: 65510
                -   remote_group_node: security_group_src
                    port: 65521
                -   direction: egress
                    remote_ip_prefix: 3.4.5.0/24
                    port: 443
        relationships:
            -   type: cloudify.relationships.connected_to
                target: security_group_src
    floatingip:
        type: cloudify.openstack.nodes.FloatingIP
    keypair:
        type: cloudify.openstack.nodes.KeyPair
        properties:
            private_key_path: { get_input: private_key_path }
